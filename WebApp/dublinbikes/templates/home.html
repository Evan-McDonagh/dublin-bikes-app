<!-- this page will inherit code from layout which is common to age -->
{% extends "layout.html" %}

<!-- to inherit start a block -->
{% block content %}

<div id="map"></div>
<div id="prediction"></div>
<script>
    // create global variables
    var map;
    var infowindow;

    // get location data from flask
    locData = JSON.parse('{{ locationdata|tojson }}')

    // function to create map called upon google connection to API below
    function initMap() {

        // create infowindow
        infowindow = new google.maps.InfoWindow();
 
        var dublin = { lat: 53.3498, lng: -6.2603 };
        // The map, centered at Dublin
        map = new google.maps.Map(
            document.getElementById('map'), {
                zoom: 13, 
                center: dublin, 
                // disable all default map controls except zoom
                disableDefaultUI: true,
                zoomControl: true,
                 });
      
        var markerArray = [];
        var marker, i, colour;

        let redMarker = "{{ url_for('static', filename='images/red-dot.png') }}"
        let greenMarker = "{{ url_for('static', filename='images/green-dot.png') }}"
        let yellowMarker = "{{ url_for('static', filename='images/yellow-dot.png') }}"
        let purpleMarker = "{{ url_for('static', filename='images/purple-dot.png') }}"

        $.getJSON("/query", { id: "all" }, function (allStationInfo) {

            // console.log(locData)
            // loop through locdata to add markers to map
            for (i = 0; i < locData.length; i++) {
                let availbikes = allStationInfo[locData[i]["id"]]["availbikes"];
                if(availbikes <= 3){
                    colour = redMarker;
                } else if (4 <= availbikes && availbikes <= 10){
                    colour = yellowMarker;
                } else if (10 < availbikes){
                    colour = greenMarker;
                } else {
                    colour = purpleMarker;
                }
                marker = new google.maps.Marker({
                    position: new google.maps.LatLng(locData[i]["lat"], locData[i]["lon"]),
                    map: map,
                    icon: {
                        url:  colour
                    }
                });

    // add on-click function using closure and IIFE
                google.maps.event.addListener(marker, 'click', (function (marker, i) {
                    return function () {
                        // Set graph to predicted availability for selected stop
                        setGraph(locData[i]["id"]);

                        // send get request with id of station
                        // execute function once results have been returned from get request
                        $.getJSON("/query", {id: locData[i]["id"]}, function(stationInfo){
                            let content = "<h5>" + locData[i]["name"] + "</h5>";
                            content += "<p>Available bikes: " + stationInfo[0]["availbikes"] + "</p>";
                            content += "<p>Available stands: " + stationInfo[0]["availstands"] + "</p>";
                            content += "<p>Status: " + stationInfo[0]["status"] + "</p>";
                            content += "<p>Banking: " + stationInfo[0]["banking"] + "</p>";
                            content += "<p>Number of bike stands: " + stationInfo[0]["numbikestands"] + "</p>";

                            // add content of get request to info window
                            infowindow.setContent(content);
                            infowindow.open(map, marker);
                        });
                    }

                    readTextFile("../static/historical-data/station_avg_availability_1.json", function(text) {
                        var stationdata = JSON.parse(text);
                        setGraph(stationdata[7]);
                    });
                    
                })(marker, i));
              
                markerArray.push(marker); 
            }
          
                  // create marker clusters using array of markers
        var markerCluster = new MarkerClusterer(map, markerArray,{imagePath: '/static/images/cluster_images/m'});
        });
    }


    //     // create marker clusters using array of markers
    //     var markerCluster = new MarkerClusterer(map, markerArray,{imagePath: '/static/images/cluster_images/m'});
    // }
</script>
<script src="https://unpkg.com/@google/markerclustererplus@4.0.1/dist/markerclustererplus.min.js"></script>
<script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBk5FkeAnIxVpfk2ufqO3F1ofYF84oDT6c&callback=initMap"></script>

<canvas id="myChart"></canvas>

<script src="https://www.chartjs.org/dist/2.9.3/Chart.min.js"></script>
<script src="https://www.chartjs.org/samples/latest/utils.js"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script> -->

<script>
    // read a given json file 
    function readTextFile(file, callback) {
        var rawFile = new XMLHttpRequest();
        rawFile.overrideMimeType('application/json')
        rawFile.open("GET", file, true);
        rawFile.onreadystatechange = function() {
            if (rawFile.readyState === 4 & rawFile.status == "200") {
                callback(rawFile.responseText);
            }
        }
        rawFile.send(null)
    }

    // graph configuration
    var hours = ["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"];
    var config = {
	    	type: 'line',
	    	data: {
	    		labels: hours,
	    		datasets: [{
	    			label: 'Available Stands',
	    			backgroundColor: window.chartColors.red,
	    			borderColor: window.chartColors.red,
	    			data: new Array(24).fill(0),
	    			fill: false,
                },
                {
	    			label: 'Available Bikes',
	    			backgroundColor: window.chartColors.blue,
	    			borderColor: window.chartColors.blue,
	    			data: new Array(24).fill(0),
	    			fill: false,
	    		}]
	    	},
	    	options: {
	    		responsive: true,
	    		// title: {
	    		// 	display: true,
	    		// 	text: 'Chart.js Line Chart'
	    		// },
	    		tooltips: {
	    			mode: 'index',
	    			intersect: false,
	    		},
	    		hover: {
	    			mode: 'nearest',
	    			intersect: true
	    		},
	    		scales: {
	    			xAxes: [{
	    				display: true,
	    				scaleLabel: {
	    					display: true,
	    					labelString: 'Time'
	    				}
	    			}],
	    			yAxes: [{
	    				display: true,
	    				scaleLabel: {
	    					display: true,
                            labelString: 'No. Available'
                        },
                        ticks: {
                            suggestedMin: 0,
                            suggestedMax: 20
                        }
	    			}]
	    		}
	    	}
        };

    // Create chart in myChart div
    var ctx = document.getElementById('myChart').getContext('2d');
    var chart = new Chart(ctx, config);

    // Set graph data to particular data for selected stop
    function setGraph(stationid) {
        readTextFile("../static/historical-data/station_avg_availability_1.json", function(text) {
                            var stationdata = JSON.parse(text);
                            var station = stationdata[stationid];
                            var availbikes = station['bikes'].map(function(x) { return Math.round(x * station['numbikestands']);});
                            var availstands = station['stands'].map(function(x) { return Math.round(x * station['numbikestands']);});

                            chart.data.datasets[0].data = availbikes;
                            chart.data.datasets[1].data = availstands;
                            chart.update();
                        });
    }

    
</script>
<!-- end the block. The word content not required -->
{% endblock content %}