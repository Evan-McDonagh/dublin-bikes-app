<!-- this page will inherit code from layout which is common to age -->
{% extends "layout.html" %}

<!-- to inherit start a block -->
{% block content %}

<div id="map"></div>
<script>
    // create global variables
    var map;
    var infowindow;

    // get location data from flask
    locData = JSON.parse('{{ locationdata|tojson }}')

    // function to create map called upon google connection to API below
    function initMap() {

        // create infowindow
        infowindow = new google.maps.InfoWindow();
 
        var dublin = { lat: 53.3498, lng: -6.2603 };
        // The map, centered at Dublin
        map = new google.maps.Map(
            document.getElementById('map'), { zoom: 13, center: dublin });


        var marker, i;

//    create empty array to add markers to
        var markerArray = [];
        // loop through locdata to add markers to map
        for (i = 0; i < locData.length; i++) {
            marker = new google.maps.Marker({
                position: new google.maps.LatLng(locData[i]["lat"], locData[i]["lon"]),
                map: map
            });
            markerArray.push(marker);

           
      }
// create marker clusters using array of markers
      var markerCluster = new MarkerClusterer(map, markerArray,
            {imagePath: '/static/images/cluster_images/m'});

// add on-click function using closure and IIFE
            google.maps.event.addListener(marker, 'click', (function (marker, i) {
                return function () {
                    // send get request with id of station
                    // execute function once results have been returned from get request
                    $.getJSON("/query", {id: locData[i]["id"]}, function(stationInfo){
                        let content = "<h5>" + locData[i]["name"] + "</h5>";
                        content += "<p>Available bikes: " + stationInfo[0]["availbikes"] + "</p>";
                        content += "<p>Available stands: " + stationInfo[0]["availstands"] + "</p>";
                        content += "<p>Status: " + stationInfo[0]["status"] + "</p>";
                        content += "<p>Banking: " + stationInfo[0]["banking"] + "</p>";
                        content += "<p>Number of bike stands: " + stationInfo[0]["numbikestands"] + "</p>";

                        // add content of get request to info window
                        infowindow.setContent(content);
                        infowindow.open(map, marker);
                    });
                    
                    

                }
            })(marker, i));
        }

</script>
<script src="https://unpkg.com/@google/markerclustererplus@4.0.1/dist/markerclustererplus.min.js"></script>
<script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBk5FkeAnIxVpfk2ufqO3F1ofYF84oDT6c&callback=initMap"></script>

<!-- end the block. The word content not required -->
{% endblock content %}