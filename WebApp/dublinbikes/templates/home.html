<!-- this page will inherit code from layout which is common to age -->
{% extends "layout.html" %}

<!-- to inherit start a block -->
{% block content %}

<input id="pac-input" class="controls" type="text" placeholder="Search Box">
<div id="map"></div>
<script>
  // create global variables
  var map;
  var infowindow;

  // get location data from flask
  locData = JSON.parse('{{ locationdata|tojson }}')

  // function to create map called upon google connection to API below
  function initMap() {

    // create infowindow
    infowindow = new google.maps.InfoWindow();

    var dublin = { lat: 53.3498, lng: -6.2603 };
    // The map, centered at Dublin
    map = new google.maps.Map(
      document.getElementById('map'), {
      zoom: 13,
      center: dublin,
      // disable all default map controls except zoom
      disableDefaultUI: true,
      zoomControl: true,
      styles: [
        {
          "elementType": "geometry",
          "stylers": [
            {
              "color": "#f5f5f5"
            }
          ]
        },
        {
          "elementType": "labels.icon",
          "stylers": [
            {
              "visibility": "off"
            }
          ]
        },
        {
          "elementType": "labels.text.fill",
          "stylers": [
            {
              "color": "#616161"
            }
          ]
        },
        {
          "elementType": "labels.text.stroke",
          "stylers": [
            {
              "color": "#f5f5f5"
            }
          ]
        },
        {
          "featureType": "administrative.land_parcel",
          "elementType": "labels.text.fill",
          "stylers": [
            {
              "color": "#bdbdbd"
            }
          ]
        },
        {
          "featureType": "poi",
          "elementType": "geometry",
          "stylers": [
            {
              "color": "#eeeeee"
            }
          ]
        },
        {
          "featureType": "poi",
          "elementType": "labels.text.fill",
          "stylers": [
            {
              "color": "#757575"
            }
          ]
        },
        {
          "featureType": "poi.park",
          "elementType": "geometry",
          "stylers": [
            {
              "color": "#e5e5e5"
            }
          ]
        },
        {
          "featureType": "poi.park",
          "elementType": "labels.text.fill",
          "stylers": [
            {
              "color": "#9e9e9e"
            }
          ]
        },
        {
          "featureType": "road",
          "elementType": "geometry",
          "stylers": [
            {
              "color": "#ffffff"
            }
          ]
        },
        {
          "featureType": "road.arterial",
          "elementType": "labels.text.fill",
          "stylers": [
            {
              "color": "#757575"
            }
          ]
        },
        {
          "featureType": "road.highway",
          "elementType": "geometry",
          "stylers": [
            {
              "color": "#dadada"
            }
          ]
        },
        {
          "featureType": "road.highway",
          "elementType": "labels.text.fill",
          "stylers": [
            {
              "color": "#616161"
            }
          ]
        },
        {
          "featureType": "road.local",
          "elementType": "labels.text.fill",
          "stylers": [
            {
              "color": "#9e9e9e"
            }
          ]
        },
        {
          "featureType": "transit.line",
          "elementType": "geometry",
          "stylers": [
            {
              "color": "#e5e5e5"
            }
          ]
        },
        {
          "featureType": "transit.station",
          "elementType": "geometry",
          "stylers": [
            {
              "color": "#eeeeee"
            }
          ]
        },
        {
          "featureType": "water",
          "elementType": "geometry",
          "stylers": [
            {
              "color": "#c9c9c9"
            }
          ]
        },
        {
          "featureType": "water",
          "elementType": "labels.text.fill",
          "stylers": [
            {
              "color": "#9e9e9e"
            }
          ]
        }
      ]

    });
    // create search box
    var input = document.getElementById('pac-input');
    var searchBox = new google.maps.places.SearchBox(input);
    // map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

    // Bias the SearchBox results towards current map's viewport.
    map.addListener('bounds_changed', function () {
      searchBox.setBounds(map.getBounds());
    });

    // Listen for the event fired when the user selects a prediction and retrieve
    // more details for that place.
    searchBox.addListener('places_changed', function () {
      var places = searchBox.getPlaces();

      if (places.length == 0) {
        return;
      }

      var bounds = new google.maps.LatLngBounds();
      places.forEach(function (place) {
        if (!place.geometry) {
          console.log("Returned place contains no geometry");
          return;
        }

        if (place.geometry.viewport) {
          // Only geocodes have viewport.
          bounds.union(place.geometry.viewport);
        } else {
          bounds.extend(place.geometry.location);
        }
      });
      map.fitBounds(bounds);
    });
    var markerArray = [];
    var marker, i, colour;

    let redMarker = "{{ url_for('static', filename='images/red-dot.png') }}"
    let greenMarker = "{{ url_for('static', filename='images/green-dot.png') }}"
    let yellowMarker = "{{ url_for('static', filename='images/yellow-dot.png') }}"
    let purpleMarker = "{{ url_for('static', filename='images/purple-dot.png') }}"

    $.getJSON("/query", { id: "all" }, function (allStationInfo) {

      // console.log(locData)
      // loop through locdata to add markers to map
      for (i = 0; i < locData.length; i++) {
        let availbikes = allStationInfo[locData[i]["id"]]["availbikes"];
        if (availbikes <= 3) {
          colour = redMarker;
        } else if (4 <= availbikes && availbikes <= 10) {
          colour = yellowMarker;
        } else if (10 < availbikes) {
          colour = greenMarker;
        } else {
          colour = purpleMarker;
        }
        marker = new google.maps.Marker({
          position: new google.maps.LatLng(locData[i]["lat"], locData[i]["lon"]),
          map: map,
          icon: {
            url: colour
          }
        });

        // add on-click function using closure and IIFE
        google.maps.event.addListener(marker, 'click', (function (marker, i) {
          return function () {
            // send get request with id of station
            // execute function once results have been returned from get request
            $.getJSON("/query", { id: locData[i]["id"] }, function (stationInfo) {
              let content = "<h5>" + locData[i]["name"] + "</h5>";
              content += "<p>Available bikes: " + stationInfo[0]["availbikes"] + "</p>";
              content += "<p>Available stands: " + stationInfo[0]["availstands"] + "</p>";
              content += "<p>Status: " + stationInfo[0]["status"] + "</p>";
              content += "<p>Banking: " + stationInfo[0]["banking"] + "</p>";
              content += "<p>Number of bike stands: " + stationInfo[0]["numbikestands"] + "</p>";

              // add content of get request to info window
              infowindow.setContent(content);
              infowindow.open(map, marker);
            });



          }
        })(marker, i));

        markerArray.push(marker);
      }

      // create marker clusters using array of markers
      var markerCluster = new MarkerClusterer(map, markerArray, { maxZoom: 14, imagePath: '/static/images/cluster_images/m' });
    });
  }

    //     // create marker clusters using array of markers
    //     var markerCluster = new MarkerClusterer(map, markerArray,{imagePath: '/static/images/cluster_images/m'});
    // }
</script>
<script src="https://unpkg.com/@google/markerclustererplus@4.0.1/dist/markerclustererplus.min.js"></script>
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBk5FkeAnIxVpfk2ufqO3F1ofYF84oDT6c&callback=initMap&libraries=places"></script>


<!-- end the block. The word content not required -->
{% endblock content %}